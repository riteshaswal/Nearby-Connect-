<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Location & User Search</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: auto;
      background-color: #ffffff;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .section {
      margin-bottom: 30px;
    }

    h2 {
      margin-bottom: 10px;
      color: #3f51b5;
    }

    .toggle-switch {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #3f51b5;
    }

    .status {
      margin-top: 10px;
      font-weight: bold;
      color: #444;
    }

    .search-bar {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .search-bar input {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    .search-bar button {
      padding: 10px 20px;
      background-color: #3f51b5;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
    }

    .search-bar button:hover {
      background-color: #2c3a8c;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      background-color: #e3f2fd;
      margin: 8px 0;
      padding: 10px;
      border-radius: 8px;
      font-size: 16px;
    }
    .result-card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #e3f2fd;
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 15px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.profile-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.profile-info img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
}

.card-actions button {
  margin-left: 10px;
  padding: 6px 12px;
  font-size: 14px;
  border-radius: 6px;
  border: none;
  color: white;
  cursor: pointer;
}

.chat-btn {
  background-color: #28a745;
}

.connection-btn {
  background-color: #007bff;
}
body {
    font-family: 'Segoe UI', sans-serif;
    background-color: #dfe9f3;
    margin: 0;
    padding-top: 60px;
}

.dashboard-nav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 60px;
    background-color: #007bff;
    display: flex;
    justify-content: space-around;
    align-items: center;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000;
}

.dashboard-nav button {
    background: none;
    border: none;
    color: white;
    font-size: 22px;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.dashboard-nav button:hover {
    transform: scale(1.2);
}
  </style>
</head>
<body>
    <nav class="dashboard-nav">
    
    <button onclick="window.location.href='proj3.4.html'"><i class="bi bi-search"></i></button>
    <button id="profileBtn"><i class="bi bi-person-circle"></i></button>
    
    <button id="geo"><i class="bi bi-geo-alt"></i></button>
</nav>
  <div class="container">
    <div class="section">
      <h2>üìç Share My Location</h2>
      <div class="toggle-switch">
        <input type="checkbox" id="locationToggle">
        <label for="locationToggle">Enable Location</label>
      </div>
      <p class="status" id="locationStatus">Location sharing is OFF</p>
    </div>

    <hr style="margin: 20px 0;">

    <div class="section">
      <h2>üîç Search Nearby Users</h2>
     <div class="search-bar">
    <input type="number" id="radiusInput" placeholder="Enter radius in km" />
    <button onclick="searchUsers()">Search</button>
</div>

<div id="resultsContainer"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const toggle = document.getElementById('locationToggle');
    const status = document.getElementById('locationStatus');

    toggle.addEventListener('change', () => {
      if (toggle.checked) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition((pos) => {
            axios.post('/toggle_location', {
              status: "on",
              lat: pos.coords.latitude,
              lon: pos.coords.longitude
            }).then(() => {
              status.textContent = "Location sharing is ON";
            });
          });
        } else {
          alert("Geolocation not supported.");
        }
      } else {
        axios.post('/toggle_location', { status: "off" }).then(() => {
          status.textContent = "Location sharing is OFF";
        });
      }
    });

   
function searchUsers() {
    const radius = document.getElementById('radiusInput').value;
    if (!radius) return alert("Please enter a radius.");

    fetch(`/search_by_radius?radius=${radius}&_=${Date.now()}`)
        .then(res => res.json())
        .then(users => {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';

            if (users.length === 0) {
                resultsContainer.innerHTML = '<p>No users found in this radius.</p>';
                return;
            }

            users.forEach(user => {
                const card = document.createElement('div');
                card.classList.add('result-card');

                const isConnected = user.is_connected;
                const isRequestSent = user.is_request_sent;

                card.innerHTML = `
                    <div class="profile-info">
                        <img src="${user.profile_pic || '/static/uploads/dummyperson copy.png'}" alt="profile">
                        <div>
                            <strong>${user.username}</strong><br>
                            <small>${user.bio || ''}</small><br>
                            <small>${user.distance.toFixed(2)} km away</small>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button onclick="window.location.href='proj3.5.html?username=${user.username}'">View Profile</button>
                        ${
                            isConnected
                                ? `<button class="chat-btn" onclick="startChat('${user.username}')">
                                       <i class="bi bi-chat-dots-fill"></i> Chat
                                   </button>`
                                : `<button 
                                        class="connection-btn"
                                        style="background-color: ${isRequestSent ? '#6c757d' : '#007bff'}"
                                   >
                                        <i class="bi bi-person-plus-fill"></i>
                                        ${isRequestSent ? "Cancel Request" : "Connect"}
                                   </button>`
                        }
                    </div>
                `;

                resultsContainer.appendChild(card);

                if (!isConnected) {
                    const connectionBtn = card.querySelector('.connection-btn');
                    connectionBtn.addEventListener('click', () => {
                        if (connectionBtn.textContent.includes("Cancel")) {
                            cancelConnection(user.username, connectionBtn);
                        } else {
                            addConnection(user.username, connectionBtn);
                        }
                    });
                }
            });
        });
}

// Dummy handlers
function startChat(username) {
    window.location.href = `/chat/${username}`;
}
function addConnection(username, buttonElement) {
    // Temporarily disable to avoid double-click
    buttonElement.disabled = true;

    fetch('/add-connection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username })
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            buttonElement.innerHTML = '<i class="bi bi-person-plus-fill"></i> Cancel Request';
            buttonElement.style.backgroundColor = "#6c757d";
        }
    })
    .catch(err => {
        console.error("Add connection failed:", err);
    })
    .finally(() => {
        buttonElement.disabled = false;
    });
}
    
function cancelConnection(username, buttonElement) {
    buttonElement.disabled = true;

    fetch('/remove-connection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username })
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            buttonElement.innerHTML = '<i class="bi bi-person-plus-fill"></i> Connect';
            buttonElement.style.backgroundColor = "#007bff";
        }
    })
    .catch(err => {
        console.error("Cancel connection failed:", err);
    })
    .finally(() => {
        buttonElement.disabled = false;
    });
}
document.getElementById('profileBtn').addEventListener('click', () => {
            window.location.href = 'proj3.3.html';
        });
        document.getElementById('geo').addEventListener('click', () => {
            window.location.href = 'proj3.9.html';
        });
  </script>
</body>
</html>