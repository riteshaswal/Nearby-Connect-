<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat with User</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: Arial, sans-serif;
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #f4f7f9;
    }

    .header {
      display: flex;
      align-items: center;
      padding: 15px;
      background-color: #5c6bc0;
      color: white;
      font-size: 20px;
      font-weight: bold;
    }

    .header img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      margin-right: 15px;
      object-fit: cover;
    }

    .message-list {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background-color: white;
      display: flex;
      flex-direction: column;
    }

    .message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
      max-width: 60%;
    }

    .message.sent {
      background-color: #dcf8c6;
      margin-left: auto;
      text-align: right;
    }

    .message.received {
      background-color: #d1e7ff;
      margin-right: auto;
      text-align: left;
    }

    .input-container {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
      background-color: #fff;
    }

    #messageInput {
      flex: 1;
      padding: 12px;
      border-radius: 20px;
      border: 1px solid #ddd;
      font-size: 16px;
      outline: none;
    }

    #sendButton {
      margin-left: 10px;
      padding: 12px 20px;
      background-color: #5c6bc0;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 16px;
      cursor: pointer;
    }

    #sendButton:hover {
      background-color: #3e4a89;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="header">
      <img id="profilePic" src="/static/uploads/dummyperson copy.png" alt="Profile Picture" />
      <span id="chatWithUser">User</span>
    </div>

    <div class="message-list" id="messageList">
      <!-- Messages appear here -->
    </div>

    <div class="input-container">
      <input type="text" id="messageInput" placeholder="Type a message..." />
      <button id="sendButton">Send</button>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const socket = io();
      const urlParams = new URLSearchParams(window.location.search);
      const chatWithUser = urlParams.get('chat_with');

      const messageList = document.getElementById('messageList');
      const sendButton = document.getElementById('sendButton');
      const messageInput = document.getElementById('messageInput');

      let currentUserId;
      let chatWithUserId;
      let skipCount = 0;
      const messageLimit = 20;
      let isFetching = false;

      function formatTimestamp(dateStr) {
        const date = new Date(dateStr);
        let hours = date.getHours();
        const minutes = date.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12;
        const mins = minutes < 10 ? '0' + minutes : minutes;
        return `${hours}:${mins} ${ampm}`;
      }

      function createMessageElement(msg, isSent) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ' + (isSent ? 'sent' : 'received');
        messageDiv.innerHTML = `
          <div>${msg.message}</div>
          <small style="display:block; margin-top:4px; font-size:12px; color:#555; text-align:${isSent ? 'right' : 'left'};">
            ${formatTimestamp(msg.timestamp)}
          </small>`;
        return messageDiv;
      }

      function appendMessage(msg, isSent) {
        const msgElement = createMessageElement(msg, isSent);
        messageList.appendChild(msgElement);
        messageList.scrollTop = messageList.scrollHeight;
      }

      function prependMessage(msg, isSent) {
        const msgElement = createMessageElement(msg, isSent);
        messageList.insertBefore(msgElement, messageList.firstChild);
      }

    function loadMessages(initial = false) {
  if (isFetching) return;
  isFetching = true;

  fetch(`/load-messages?user1=${currentUserId}&user2=${chatWithUserId}&skip=${skipCount}&limit=${messageLimit}`)
    .then(res => res.json())
    .then(data => {
      if (initial) messageList.innerHTML = '';

      const scrollBefore = messageList.scrollHeight;

      data.messages.forEach(msg => {
        // ðŸ‘‡ Extract proper string ID from msg.from (might be plain string or {$oid: "..."} from MongoDB)
        const fromId = typeof msg.from === 'object' && msg.from.$oid ? msg.from.$oid : msg.from;
        const myId = typeof currentUserId === 'object' && currentUserId.$oid ? currentUserId.$oid : currentUserId;

        const isSent = fromId === myId;

        if (initial) {
          appendMessage(msg, isSent);
        } else {
          prependMessage(msg, isSent);
        }
      });

      if (!initial) {
        const scrollAfter = messageList.scrollHeight;
        messageList.scrollTop += (scrollAfter - scrollBefore);
      }

      skipCount += data.messages.length;
      isFetching = false;
    })
    .catch(err => {
      console.error("Error loading messages:", err);
      isFetching = false;
    });
}
function sendMessage() {
  const messageText = messageInput.value.trim();
  if (!messageText) return;

  const msg = {
    sender_id: currentUserId,
    receiver_id: chatWithUserId,
    message: messageText,
    timestamp: new Date().toISOString()
  };

  socket.emit('send_message', msg);
  appendMessage(msg, true);
  messageInput.value = '';

  // ðŸ”¥ Emit extra event to notify proj3.7.html
 
}

      sendButton.addEventListener('click', sendMessage);
      messageInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') sendMessage();
      });

      messageList.addEventListener('scroll', () => {
        if (messageList.scrollTop < 100 && !isFetching) {
          loadMessages(false);
        }
      });

      socket.on('receive_message', msg => {
        const isChattingWith = msg.sender_id === chatWithUserId && msg.receiver_id === currentUserId;
        if (isChattingWith) {
          appendMessage(msg, false);
        }
      });

      Promise.all([
        fetch('/current-user').then(res => res.json()),
        fetch(`/user-profile?username=${encodeURIComponent(chatWithUser)}`).then(res => res.json())
      ])
      .then(([current, data]) => {
        if (!current._id || !data._id) throw new Error("Missing user ID");

        currentUserId = current._id;
        chatWithUserId = data._id;

        socket.emit('join', { user_id: currentUserId });

        document.getElementById('chatWithUser').textContent = chatWithUser;
        const pic = data.profile_pic?.trim() ? data.profile_pic : '/static/uploads/dummyperson copy.png';
        document.getElementById('profilePic').src = pic;

        loadMessages(true);
      })
      .catch(err => {
        console.error('Error setting up chat:', err);
      });
    });
    
  </script>
<script>
  const chatWith = new URLSearchParams(window.location.search).get('chat_with');

  // Notify opener (proj3.7.html) that this chat was opened
  if (window.opener) {
    window.opener.postMessage({ type: 'chat_opened', username: chatWith }, "*");
  }
  const me = localStorage.getItem('user_id');
const chat_with = new URLSearchParams(window.location.search).get('chat_with');

fetch('/api/mark_seen', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ me, chat_with })
});
</script>
</body>
</html>